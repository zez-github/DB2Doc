<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据库文档生成器</title>
    <link href="{{ url_for('static', filename='lib/bootstrap/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='lib/fontawesome/css/all.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="w-100 h-100" id="appRoot">
        <!-- 页面标题和切换连接按钮 -->
        <div class="bg-light border-bottom p-3" id="appHeader">
            <div class="d-flex justify-content-between align-items-center gap-3">
                <div class="flex-grow-1">
                    <h1 class="h3 mb-0">
                        <i class="fas fa-database text-primary"></i>
                        数据库文档生成器
                    </h1>
                    <!-- 连接信息简化：摘要常驻，详情按需展开 -->
                    <div class="small text-muted mt-1 d-flex align-items-center gap-2">
                        <i class="fas fa-plug"></i>
                        <span id="currentConnectionSummary">未连接到任何数据库</span>
                        <button class="btn btn-sm btn-link p-0" type="button"
                                data-bs-toggle="collapse" data-bs-target="#currentConnectionCollapse"
                                aria-expanded="false" aria-controls="currentConnectionCollapse">
                            详情
                        </button>
                    </div>
                </div>
                <div class="btn-group flex-shrink-0">
                    <button type="button" class="btn btn-outline-primary" id="refreshTablesBtn" title="刷新表列表">
                        <i class="fas fa-sync-alt"></i> 刷新表
                    </button>
                    <button type="button" class="btn btn-outline-dark" id="openDiagramBtn" title="打开数据库关系图（将使用已选中的表）">
                        <i class="fas fa-project-diagram"></i> 关系图
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="changeConnectionBtn">
                        <i class="fas fa-exchange-alt"></i> 切换连接
                    </button>
                </div>
            </div>

            <div class="collapse mt-2" id="currentConnectionCollapse">
                <div class="bg-white border rounded p-2">
                    <div id="currentConnectionInfo" class="text-muted">
                        <small>未连接到任何数据库</small>
                    </div>
                </div>
            </div>
            <!-- 模式导航：浏览 / 标注 / 导出 -->
            <ul class="nav nav-tabs mt-3" id="modeTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="modeBrowseTab" type="button" role="tab" data-mode="browse">
                        <i class="fas fa-search"></i> 浏览
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="modeAnnotateTab" type="button" role="tab" data-mode="annotate">
                        <i class="fas fa-pen-to-square"></i> 标注
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="modeExportTab" type="button" role="tab" data-mode="export">
                        <i class="fas fa-file-export"></i> 导出
                    </button>
                </li>
            </ul>
        </div>

        <!-- 三列布局主体内容 -->
        <div class="row g-0" id="appBody" style="height: calc(100vh - 64px);">
            <!-- 第一列 - 表列表 -->
            <div class="col-md-3 border-end bg-white" id="leftColumn">
                <div class="h-100 d-flex flex-column">
                    <!-- 表列表区域 -->
                    <div class="flex-grow-1 overflow-auto">
                        <div class="p-3">
                            <!-- 表选择区域 -->
                            <div id="tablesSection" class="mt-3" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0">表列表</h5>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-secondary" id="selectAllBtn">全选</button>
                                        <button type="button" class="btn btn-outline-secondary" id="deselectAllBtn">取消全选</button>
                                        <button type="button" class="btn btn-outline-warning" id="selectNewOnlyBtn" style="display: none;">
                                            <i class="fas fa-plus"></i> 仅选新表
                                        </button>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <input type="text" class="form-control form-control-sm" id="tableSearch" placeholder="搜索表名...">
                                </div>
                                <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                                    <div class="d-flex align-items-center gap-2 small text-muted">
                                        <span class="legend-dot legend-dot--danger" aria-hidden="true"></span>
                                        <span>红色=待补充说明</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge bg-secondary" id="tablesTotalBadge">总表 0</span>
                                        <span class="badge bg-info" id="tablesFilteredBadge" style="display: none;">显示 0</span>
                                        <span class="badge bg-primary" id="tablesSelectedBadge">已选 0</span>
                                        <span class="badge bg-danger" id="tablesMissingBadge">待补充 0</span>
                                    </div>
                                </div>
                                <div class="alert alert-info p-2 mb-2 small" role="alert">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>提示：</strong>选择表后点击"关系图"按钮，将仅绘制选中的表。建议选择核心表（通常10-30张），避免图表过大导致渲染失败。
                                </div>
                                <div class="form-check form-switch mb-2">
                                    <input class="form-check-input" type="checkbox" id="filterMissingOnly">
                                    <label class="form-check-label small" for="filterMissingOnly">仅显示待补充</label>
                                </div>
                                <div id="tablesContainer" class="list-group">
                                    <!-- 表格复选框将在这里动态生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 第二列 - 表字段详情和编辑 -->
            <div class="col-md-5 border-end bg-white middle-column">
                <div class="h-100 d-flex flex-column">
                    <!-- 表字段详情 -->
                    <div class="flex-grow-1 overflow-auto p-3">
                        <!-- 浏览模式工作区 -->
                        <div id="browseWorkspace">
                            <div id="tableDetailSection" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3 gap-2">
                                    <h5 class="mb-0">
                                        <i class="fas fa-table"></i>
                                        <span id="currentTableName"></span> 表结构
                                        <span id="dirtyIndicator" class="badge bg-warning text-dark ms-2" style="display:none;">未保存</span>
                                    </h5>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-warning" id="nextMissingBtn" title="定位到当前表的下一处待补充">
                                            <i class="fas fa-location-arrow"></i> 下一处
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-info" id="generateMissingBtn" title="仅生成缺失的表/字段说明">
                                            <i class="fas fa-wand-magic-sparkles"></i> 补齐缺失
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="generateTableDescBtn">
                                            <i class="fas fa-brain"></i> 生成表说明
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="saveTableDescBtn">
                                            <i class="fas fa-save"></i> 保存
                                        </button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="tableDescription" class="form-label">表说明</label>
                                    <textarea class="form-control" id="tableDescription" rows="2" placeholder="请输入表的说明信息..."></textarea>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>字段名</th>
                                                <th>数据类型</th>
                                                <th>是否为空</th>
                                                <th>默认值</th>
                                                <th>字段说明</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="fieldsTableBody">
                                            <!-- 字段数据将在这里动态生成 -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-3 text-center">
                                    <button type="button" class="btn btn-outline-info" id="generateAllFieldsBtn">
                                        <i class="fas fa-brain"></i> 生成所有字段说明
                                    </button>
                                </div>
                            </div>
                            <div id="noTableSelected" class="text-center text-muted d-flex flex-column justify-content-center h-100">
                                <i class="fas fa-mouse-pointer fa-3x mb-3 opacity-50"></i>
                                <p class="mb-0">请先连接数据库并选择一个表</p>
                                <small>连接数据库后，从左侧选择一个表查看详情</small>
                            </div>
                        </div>

                        <!-- 标注模式工作区（Phase1：先提供清晰入口，后续再增强为“下一处/批量补齐”流程） -->
                        <div id="annotateWorkspace" style="display: none;">
                            <div class="alert alert-info mb-2">
                                <div class="d-flex justify-content-between align-items-start gap-2">
                                    <div>
                                        <i class="fas fa-info-circle"></i>
                                        标注模式：聚焦处理<strong>待补充注释</strong>的表与字段（建议左侧启用“仅显示待补充”）。
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-secondary" id="annotateRefreshBtn">
                                            <i class="fas fa-rotate"></i> 刷新
                                        </button>
                                        <button type="button" class="btn btn-outline-warning" id="annotateNextBtn">
                                            <i class="fas fa-location-arrow"></i> 去下一处
                                        </button>
                                        <button type="button" class="btn btn-outline-success" id="annotateGenerateSaveAllBtn" title="可能需要较长时间">
                                            <i class="fas fa-magic"></i> 一键生成并保存全部待补充
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="annotateMissingList" class="list-group">
                                <!-- 由前端动态填充 -->
                            </div>
                        </div>

                        <!-- 导出模式工作区：导出前的选择与校验摘要 -->
                        <div id="exportWorkspace" style="display: none;">
                            <div class="alert alert-light border">
                                <div class="fw-semibold mb-1"><i class="fas fa-file-export text-primary me-1"></i> 导出摘要</div>
                                <div class="small text-muted">
                                    左侧勾选需要导出的表；右侧设置导出路径/增量模式，然后点击“导出DB文档”。
                                </div>
                                <div class="mt-2 d-flex flex-wrap gap-2">
                                    <span class="badge bg-primary" id="exportSelectedBadge">已选 0</span>
                                    <span class="badge bg-danger" id="exportMissingBadge">待补充 0</span>
                                </div>
                            </div>
                            <div class="small text-muted">
                                提示：导出用于保存到本地；如需把注释持久化到数据库，请在“浏览/标注”中保存表/字段注释。
                            </div>
                            <div class="mt-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="fw-semibold"><i class="fas fa-clock-rotate-left text-primary me-1"></i> 导出历史</div>
                                    <button type="button" class="btn btn-sm btn-outline-danger" id="clearExportHistoryBtn">
                                        <i class="fas fa-trash"></i> 清空
                                    </button>
                                </div>
                                <div id="exportHistoryList" class="list-group">
                                    <!-- 由前端动态填充 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 第三列 - 数据库功能介绍和文档保存设置 -->
            <div class="col-md-4 bg-white" id="rightColumn">
                <div class="h-100 d-flex flex-column">
                    <!-- 折叠按钮 -->
                    <div class="d-flex justify-content-start p-1 bg-light border-bottom">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="collapseRightBtn" title="折叠右侧面板">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <!-- 数据库功能介绍 -->
                    <div id="dbDescriptionSection" class="p-3 border-bottom bg-light" style="display: none;">
                        <div class="bg-white border border-primary rounded">
                            <div class="bg-primary text-white p-2 rounded-top">
                                <h6 class="mb-0">
                                    <i class="fas fa-info-circle"></i> 数据库功能介绍
                                </h6>
                            </div>
                            <div class="p-2">
                                <div class="mb-2">
                                    <label for="dbDescription" class="form-label">
                                        <i class="fas fa-edit"></i> 请描述该数据库的主要功能和用途
                                    </label>
                                    <textarea class="form-control form-control-sm" id="dbDescription" name="dbDescription" 
                                              rows="3" placeholder="例如：这是一个电商系统的数据库，主要用于管理用户信息、商品信息、订单处理、库存管理等功能...">
                                    </textarea>
                                </div>
                                <div class="mb-2">
                                    <button type="button" class="btn btn-outline-success w-100" id="generateAllTablesBtn">
                                        <i class="fas fa-magic"></i> 一键生成所有表和字段描述
                                    </button>
                                </div>
                                <div class="alert alert-info p-2 mb-0">
                                    <i class="fas fa-lightbulb"></i>
                                    <small>详细的功能介绍能帮助AI更准确地推断字段含义</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 浏览/标注模式：持久化提示与快捷动作 -->
                    <div id="browseAssistantSection" class="p-3 border-bottom bg-light" style="display: none;">
                        <div class="bg-white border rounded p-3">
                            <div class="fw-semibold mb-2">
                                <i class="fas fa-database text-primary"></i> 持久化
                            </div>
                            <div class="small text-muted mb-2">
                                “保存”会将表/字段注释写回数据库；“导出”会将已选表结构与注释导出到本地 Markdown。
                            </div>
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-primary" id="assistantSaveCurrentBtn">
                                    <i class="fas fa-save"></i> 保存当前表注释到数据库
                                </button>
                                <button type="button" class="btn btn-outline-success" id="assistantGoExportBtn">
                                    <i class="fas fa-file-export"></i> 前往导出
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 导出模式：导出/增量更新设置 -->
                    <div id="exportAssistantSection" class="p-3 bg-light" style="display: none;">
                        <!-- 增量更新设置（从左侧归位到导出模式） -->
                        <div id="incrementalSection" class="mb-3">
                            <div class="bg-white border border-info rounded">
                                <div class="bg-info text-white p-2 rounded-top">
                                    <h6 class="mb-0">
                                        <i class="fas fa-sync-alt"></i> 增量更新模式
                                    </h6>
                                </div>
                                <div class="p-2">
                                    <div class="form-check form-switch mb-2">
                                        <input class="form-check-input" type="checkbox" id="incrementalMode">
                                        <label class="form-check-label" for="incrementalMode">
                                            <strong>启用增量更新</strong>
                                        </label>
                                    </div>

                                    <div id="existingDocSection" style="display: none;">
                                        <div class="row mb-2">
                                            <div class="col-md-12">
                                                <label for="existingDocPath" class="form-label">
                                                    <i class="fas fa-file-alt"></i> 选择已有文档
                                                </label>
                                                <input type="text" class="form-control form-control-sm" id="existingDocPath"
                                                       placeholder="选择要更新的MD文档..." readonly>
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-md-12">
                                                <button type="button" class="btn btn-sm btn-outline-info" id="selectDocBtn">
                                                    <i class="fas fa-file-upload"></i> 选择文档
                                                </button>
                                            </div>
                                        </div>

                                        <div id="existingTablesInfo" class="alert alert-light p-2" style="display: none;">
                                            <h6><i class="fas fa-info-circle"></i> 文档信息</h6>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <small class="text-muted">已存在表格数量：</small>
                                                    <span id="existingTablesCount" class="badge bg-secondary">0</span>
                                                </div>
                                                <div class="col-md-6">
                                                    <small class="text-muted">将新增表格数量：</small>
                                                    <span id="newTablesCount" class="badge bg-success">0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 文档保存设置 -->
                        <div id="outputSection" style="display: none;">
                            <h5><i class="fas fa-save"></i> 文档保存设置</h5>
                            <div class="bg-white border rounded p-3 mt-2">
                                <div class="mb-3">
                                    <label for="outputPath" class="form-label">
                                        <i class="fas fa-folder-open"></i> 文档保存路径
                                    </label>
                                    <input type="text" class="form-control" id="outputPath" name="outputPath"
                                           placeholder="选择文档保存位置..." readonly>
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-outline-primary" id="selectPathBtn">
                                        <i class="fas fa-folder"></i> 选择路径
                                    </button>
                                </div>
                                <div class="mb-3">
                                    <label for="fileName" class="form-label">
                                        <i class="fas fa-file"></i> 文件名
                                    </label>
                                    <input type="text" class="form-control" id="fileName" name="fileName"
                                           placeholder="将自动生成文件名..." readonly>
                                    <div class="form-text">文件名格式：数据库名_文档_时间戳.md</div>
                                </div>
                            </div>
                        </div>

                        <!-- 生成按钮（仅导出模式显示） -->
                        <div class="mt-3">
                            <button type="button" class="btn btn-success btn-lg w-100" id="generateBtn" disabled>
                                <i class="fas fa-file-alt"></i> 导出DB文档
                            </button>
                            <div id="generateHint" class="form-text text-muted mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 侧边助手迷你操作条：右侧默认收起时展示（常驻入口） -->
        <div id="assistantMiniBar" class="assistant-mini-bar" style="display:none;" aria-label="侧边助手快捷操作">
            <button type="button" class="btn btn-sm btn-outline-secondary assistant-mini-bar__btn" id="expandAssistantBtn" title="展开侧边助手">
                <i class="fas fa-chevron-left" aria-hidden="true"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary assistant-mini-bar__btn" id="miniSaveBtn" title="保存当前表注释到数据库">
                <i class="fas fa-save" aria-hidden="true"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-success assistant-mini-bar__btn" id="miniExportBtn" title="前往导出">
                <i class="fas fa-file-export" aria-hidden="true"></i>
            </button>
        </div>

        <!-- 进度和日志区域 - 底部抽屉（默认收起一行，必要时展开日志） -->
        <div id="progressSection" class="bottom-drawer bottom-drawer--progress collapsed" style="display: none;">
            <div class="bottom-drawer__header">
                <div class="d-flex align-items-start justify-content-between gap-3">
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="fw-semibold">
                                <i class="fas fa-tasks text-primary me-2"></i>生成进度
                            </div>
                            <span id="progressText" class="text-muted small">0/0 已完成</span>
                        </div>
                        <div class="progress mt-2">
                            <div id="progressBar" class="progress-bar" 
                                 role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                0%
                            </div>
                        </div>
                        <!-- 当前处理状态（收起状态也可见） -->
                        <div id="currentStatus" class="bottom-drawer__status mt-2" style="display: none;">
                            <span class="spinner-border spinner-border-sm text-primary me-2" role="status" aria-hidden="true"></span>
                            <span id="currentStatusText" class="text-muted small">准备开始...</span>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary bottom-drawer__toggle" id="toggleProgressDrawerBtn"
                            aria-expanded="false" title="展开日志">
                        <i class="fas fa-chevron-up" aria-hidden="true"></i>
                    </button>
                </div>
            </div>

            <div class="bottom-drawer__body">
                <div class="border rounded bg-white">
                    <div class="bg-light p-2 rounded-top">
                        <h6 class="mb-0">
                            <i class="fas fa-list-ul"></i> 执行日志
                        </h6>
                    </div>
                    <div class="p-2 bottom-drawer__logs">
                        <div id="logsContainer" class="logs-container">
                            <!-- 日志将在这里显示 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 下载区域 - 底部抽屉 -->
        <div id="downloadSection" class="bottom-drawer bottom-drawer--download" style="display: none;">
            <div class="bottom-drawer__header">
                <div class="alert alert-success mb-0">
                <i class="fas fa-check-circle"></i>
                文档生成完成！
            </div>
            </div>
            <div class="bottom-drawer__body text-center">
                <div class="small text-muted mb-3">
                    <div class="fw-semibold">文件路径</div>
                    <div id="downloadFilePath" class="text-break"></div>
                </div>
                <div class="d-flex flex-wrap justify-content-center gap-2 mb-3">
                    <button type="button" class="btn btn-outline-secondary" id="copyPathBtn">
                        <i class="fas fa-copy"></i> 复制路径
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="openFolderBtn">
                        <i class="fas fa-folder-open"></i> 打开文件夹
                    </button>
                    <button type="button" class="btn btn-outline-success" id="reopenExportBtn">
                        <i class="fas fa-rotate-left"></i> 再次导出
                    </button>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-lg me-3" id="previewBtn">
                    <i class="fas fa-eye"></i> 预览文档
                </button>
                <button type="button" class="btn btn-primary btn-lg" id="downloadBtn">
                    <i class="fas fa-download"></i> 下载文档
                </button>
            </div>
        </div>
    </div>

    <!-- 引入JavaScript库 -->
    <script src="{{ url_for('static', filename='lib/bootstrap/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>